<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//E" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="classMapper">

	<resultMap id="classResult" type="Class">
		<result column="clno" property="clNo" />
		<result column="mno" property="memNo" />
		<result column="category" property="category" />
		<result column="cl_name" property="clName" />
		<result column="cl_content" property="clContent" />
		<result column="cl_date" property="clDate" />
		<result column="cl_price" property="clPrice" />
		<result column="kit" property="kit" />
		<result column="cl_img" property="clImg" />
		<result column="cl_img2" property="clImg2" />
		<result column="cl_img3" property="clImg3" />
		<result column="cl_kitimg" property="clKitImg" />
		<result column="hashtag" property="hashtag" />
		<result column="count" property="count" />
		<result column="nickname" property="memNo" />
		<result column="like_count" property="like" />
	</resultMap>
	
	<resultMap id="classReviewResult" type="ClassReview">
		<result column="c_rno" property="crNo" />
		<result column="clno" property="clNo" />
		<result column="mno" property="memNo" />
		<result column="user_name" property="memNo" />
		<result column="content" property="content" />
		<result column="star" property="star" />
		<result column="filepath" property="filePath" />
		<result column="create_date" property="createDate" />
		<result column="status" property="status" />
		<result column="reconum" property="recommend" />
	</resultMap>

	<update id="increaseCount">
		update 
			   class
		   set count = count + 1
		 where CLNO = #{clNo}
		   and cl_status = 'Y'
	</update>
	
	<select id="selectClass" resultMap="classResult">
		select
		       clno
		     , nickname
		     , category
		     , cl_name
		     , cl_content
		     , cl_date
		     , cl_price
		     , kit
		     , cl_img
		     , cl_img2
		     , cl_img3
		     , cl_kitimg
		     , hashtag
		     , count
		     , (
		        select count(*)
		          from like_item
		         where gb_no = 1
		           and refer_no = clno
		        ) as like_count
		  from class
          JOIN member USING (MNO)
		 where cl_status = 'Y'
           and grade = 'T'
		   and clno = #{clNo}
	</select>
	
	<select id="classSearchListCount" resultType="_int">
        select count(*)
		  from class
		  JOIN member USING (MNO)
		 where cl_status = 'Y'
		   and grade = 'T'
		   and cl_name like '%' || #{keyword} || '%'
		   <choose>
		 		<when test="category == '1'">
		 			and category = 1
		 		</when>
		 		<when test="category == '2'">
		 			and category = 2
		 		</when>
		 		<when test="category == '3'">
		 			and category = 3
		 		</when>
		 		<when test="category == '4'">
		 			and category = 4
		 		</when>
		 		<when test="category == '5'">
		 			and category = 5
		 		</when>
		 		<when test="category == '6'">
		 			and category = 6
		 		</when>
		 		<when test="category == '7'">
		 			and category = 7
		 		</when>
		 		<when test="category == '8'">
		 			and category = 8
		 		</when>
		 		<otherwise>
		 		</otherwise>
		   </choose>
	</select>
	
	<select id="classSearchList" resultMap="classResult">
        select
		       clno
		     , nickname
		     , category
		     , cl_name
		     , cl_date
		     , cl_price
		     , cl_img
		     , count
		     , (
		        select count(*)
		          from like_item
		         where gb_no = 1
		           and refer_no = clno
		        ) as like_count
		  from class
		  JOIN member USING (MNO)
		 where cl_status = 'Y'
		   and grade = 'T'
		   and cl_name like '%' || #{keyword} || '%'
		   <choose>
				<when test="category == 1">
				   and category = 1
				</when>
				<when test="category == 2">
				   and category = 2
				</when>
				<when test="category == 3">
				   and category = 3
				</when>
				<when test="category == 4">
				   and category = 4
				</when>
				<when test="category == 5">
				   and category = 5
				</when>
				<when test="category == 6">
				   and category = 6
				</when>
				<when test="category == 7">
				   and category = 7
				</when>
				<when test="category == 8">
				   and category = 8
				</when>
				<otherwise>
				
				</otherwise>
		   </choose>
   		   <choose>
		   		<when test="array == 'like'">
					 order
					    by like_count desc
		   		</when>
		   		<when test="array == 'date'">
					 order
					    by cl_date desc
		   		</when>
		   </choose>
	</select>
	
	<select id="checkClassLike" resultType="_int">
		select count(*)
		  from like_item
		 where mno = #{memNo}
		   and refer_no = #{referNo}
	</select>
	
	<insert id="insertClassLike">
		insert
		  into like_item
		values
			 (
			   #{memNo}
			 , 1
			 , #{referNo}
			 )
	</insert>
	
	<delete id="deleteClassLike">
		delete 
		  from like_item
		 where mno = #{memNo}
		   and refer_no = #{referNo}
	</delete>
	
	<select id="selectClassReviewList" resultMap="classReviewResult">
		select c.c_rno
		     , c.clno
		     , user_name
		     , c.content
		     , c.star
		     , c.FILEPATH
		     , to_char(c.create_date, 'YYYY-MM-DD') as create_date
		     , status
   		     , (
		        select count(*)
		          from recommend
		         where gb_no = 1
		           and refer_no = c_rno
		        ) as reconum
		  from class_review c
          join member using (mno)
		 where status = 'Y'
		   and clno = #{clNo}
	     order
   			by create_date desc
	</select>
	
	<select id="selectClassReviewTopList" resultMap="classReviewResult">
		select c.c_rno
		     , c.clno
		     , c.mno
		     , c.FILEPATH
		     , c.status
		     , (
		        select count(*)
		          from recommend
		         where gb_no = 1
		           and refer_no = c_rno
		        ) as reconum
		  from class_review c
		 where status = 'Y'
		   and filePath is not null
		   and clno = #{clNo}
		 order
		    by reconum desc
	</select>

	<select id="selectClassReviewMainList" resultMap="classReviewResult">
		select c.c_rno
		     , c.clno
		     , user_name
		     , c.content
		     , c.star
		     , c.FILEPATH
		     , to_char(create_date, 'YYYY-MM-DD') as create_date
		     , c.status
		     , (
		        select count(*)
		          from recommend
		         where gb_no = 1
		           and refer_no = c_rno
		        ) as reconum
		  from class_review c
          join member using (mno)
		 where status = 'Y'
		   and clno = #{clNo}
		 order
		    by reconum desc
	</select>
	
	<select id="classReviewListCount" resultType="_int">
		select count(*)
		  from class_review
		 where status = 'Y'
		   and clNo = #{clNo}
	</select>
	
</mapper>
