<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="adMemMapper">

	<resultMap type="Member" id="memberResult">
		<result column="mno" property="memNo" />
	    <result column="user_id" property="userId" />
        <result column="user_pwd" property="userPwd" />
        <result column="user_name" property="userName" />
        <result column="nickname" property="nickName" />
        <result column="phone" property="phone" />
        <result column="profile" property="profileImg" />
        <result column="point" property="point" />
        <result column="grade" property="grade" />
        <result column="u_status" property="userStatus" />
        <result column="report" property="report" />
        <result column="enroll_date" property="enrollDate" />
        <result column="sleep_date" property="sleepDate" />
        <result column="escape_date" property="escapeDate" />		
	</resultMap>

	<resultMap type="Point" id="pointResult">
		<result column="pno" property="pointNo" />
	    <result column="mno" property="memNo" />
        <result column="type" property="type" />
        <result column="p_order_no" property="orderNo" />
        <result column="p_date" property="pointDate" />		
		<result column="p_price" property="pointPrice" />	
		<result column="reason" property="reason" />	
		<result column="deadline" property="deadLine" />	
	</resultMap>	
	
	<resultMap type="Coupon" id="couponResult">
		<result column="cno" property="couponNo" />
		<result column="mno" property="memNo" />
	    <result column="cname" property="couponName" />
        <result column="discount" property="discount" />
        <result column="dedate" property="dedate" />
        <result column="count" property="count" />
        <result column="maxcount" property="maxCount"/>
	</resultMap>	
	
	<resultMap type="MemCoupon" id="memCouponResult">
		<result column="pcno" property="memCouponNo" />
	    <result column="mno" property="memNo" />
        <result column="cno" property="couponNo" />
        <result column="use" property="useYN" />
        <result column="endate" property="enDate" />
        <result column="dedate" property="deDate" />
	</resultMap>
	
	<select id="loginAdmin" resultMap="memberResult">
		select
			  	mno
		      , user_id
		      , user_pwd
		      , user_name
		      , nickname
		      , phone
		      , profile
		      , point
		      , u_status
		      , to_char(enroll_date, 'YYYY-MM-DD') enroll_date
		      , sleep_date
		      , escape_date
		  from member
		 where u_status = 'Y'
		   and grade = 'A'
		   and user_id = #{userId}
	</select>	
	
	<!-- 전체회원 수 조회 -->
	<select id="selectMemCount" resultType="_int">
		select
		       count(*)
		  from member
		 where u_status = 'Y'
		   and grade in ('S', 'T')  
	</select>
	
	<!-- 전체회원 목록 조회 -->
	<select id="selectMemList" resultMap="memberResult">
		select
			  	mno
		      , user_id
		      , user_name
		      , nickname
		      , phone
		      , grade
		      , enroll_date
		  from member
		 where u_status = 'Y'
		 order
		    by mno desc
	</select>
	
	<!-- 학생 회원 수 조회 -->
	<select id="selectSMemCount" resultType="_int">
		select
		       count(*)
		  from member
		 where u_status = 'Y'
		   and grade = 'S'
	</select>
	
	<!-- 학생회원 목록 조회 -->
	<select id="selectSMemList" resultMap="memberResult">
		select
			  	mno
		      , user_id
		      , user_name
		      , nickname
		      , phone
		      , grade
		      , enroll_date
		  from member
		 where u_status = 'Y'
		   and grade = 'S'
		 order
		    by mno desc
	</select>
	
	<!-- 강사 회원수 조회 -->
	<select id="selectTMemCount" resultType="_int">
			select
			       count(*)
			  from member
			 where u_status = 'Y'
			   and grade = 'T'
	</select>
	
	<!-- 강사목록 조회 -->
	<select id="selectTMemList" resultMap="memberResult">
		select
			  	mno
		      , user_id
		      , user_name
		      , nickname
		      , phone
		      , grade
		      , enroll_date
		  from member
		 where u_status = 'Y'
		   and grade = 'T'
		 order
		    by mno desc
	</select>
	
	<!-- 쿠폰목록 카운트 -->
	<select id="selectCouponCount" resultType="_int">
		select
		       count(*)
		  from couponlist
	</select>
	
	<!-- 쿠폰리스트 조회하기 -->
	<select id="selectCouponList" resultMap="couponResult">
		select
		       cno
		     , cname
		     , discount
		     , maxcount
		     , to_char(dedate, 'YYYY-MM-DD') as dedate
		     , NVL((select count(*)
		          from coupon
		          group by cno
		          having couponlist.cno = coupon.cno),  0) as count
		 from couponlist
		 order
		    by cno desc
	</select>
	
	<!-- 쿠폰목록 등록하기 -->
	<insert id="enrollCoupon">
		insert 
		  into COUPONLIST 
		     (
		       CNO
		     , CNAME
		     , DISCOUNT
		     , DEDATE
		     , maxcount
		     )
		values
		     (
		       SEQ_CNO.nextval
		     , #{couponName}
		     , #{discount}
		     , #{dedate}
		     , #{maxCount}
		     )
	</insert>
	
	<!-- 쿠폰 삭제하기 -->
	<delete id="deleteCoupon">
		delete 
		  from couponlist 
		 where cno = #{cno}
	</delete>
	
	<!-- 해당 쿠폰 정보 가져오기 -->
	<select id="selectCoupon" resultMap="couponResult">
		select
		       cno
		     , cname
		     , discount
		     , maxcount
		     , to_char(dedate, 'YYYY-MM-DD') as dedate
		  from couponlist
		 where cno = #{cno}
	</select>
	
	<!-- 쿠폰 지급용 양식에 보여질 memlist -->
	<select id="selectAllMember" resultMap="memberResult">
		select
			   mno
			 , user_id
			 , user_name
		  from member
		 where u_status='Y'
		   and grade = 'S'  
	</select>
	
	<!-- 멤버별 쿠폰 지급 -->
	<insert id="insertMemCoupon">
		insert  
		  into COUPON
		     (
		       pcno
		     , mno
		     , cno
		     , dedate
		     )
		values
		     (
		       SEQ_CPNO.nextval
		     , #{memNo}
		     , #{couponNo}
		     , #{deDate}
		     )
	</insert>
	
	<update id="updateCoupon">
		update couponlist
		   set (
		          cname = #{couponName}
		        , discount = #{discount}
		        , maxcount = #{maxCount}
		        , dedate = #{dedate}
		        , endate = sysdate
		        )
		where cno = #{couponNo}
	</update>
	
	
	
	
	
	
	
	
	
	
	
</mapper>
